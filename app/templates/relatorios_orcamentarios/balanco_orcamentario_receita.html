<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balanço Orçamentário da Receita - Consolidado</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background-color: #f5f7fa; color: #2c3e50; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 40px; border-radius: 10px 10px 0 0; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); text-align: center; }
        .header h1 { font-size: 32px; font-weight: 600; margin-bottom: 10px; }
        .top-actions {
            background: white; padding: 15px 30px; display: flex;
            justify-content: center; gap: 15px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .filter-actions {
            background: white; padding: 10px 30px; display: flex;
            justify-content: center; flex-wrap: wrap; gap: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-top: 1px solid #f0f4f8;
        }
        .btn-filter {
            background: #f0f4f8; color: #5a6c7d; border: 1px solid #e2e8f0;
            padding: 8px 18px; font-size: 13px; border-radius: 6px;
            text-decoration: none; transition: all 0.2s;
        }
        .btn-filter:hover {
            background-color: #e2e8f0;
            border-color: #cbd5e0;
        }
        .btn-filter.active {
            background-color: #2a5298;
            color: white;
            border-color: #1e3c72;
            font-weight: 600;
        }
        .periodo-info { background: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #2a5298; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border-top: 1px solid #f0f4f8; }
        .select-coug { background: #2a5298; color: white; padding: 8px 20px; border-radius: 20px; font-size: 13px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; min-width: 200px; }
        .table-container { background: white; overflow: auto; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border-radius: 0 0 10px 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        thead { background: #1e3c72; color: white; position: sticky; top: 0; z-index: 10; }
        thead th { padding: 18px 15px; text-align: center; font-weight: 600; font-size: 13px; text-transform: uppercase; }
        tbody tr { border-bottom: 1px solid #e8ecf0; }
        tbody td { padding: 14px 15px; text-align: right; font-size: 14px; vertical-align: middle; }
        tbody td:first-child { text-align: left; font-weight: 500; display: flex; align-items: center; }
        .nivel-0 { background-color: #f0f4f8; font-weight: 600; }
        .nivel-0 td:first-child { padding-left: 25px; color: #1e3c72; font-size: 15px; }
        .nivel-1 { background-color: #fff; }
        .nivel-1 td:first-child { padding-left: 45px; color: #5a6c7d; font-size: 14px; font-weight: 500; }
        .nivel-2, .nivel-3 { display: none; }
        .nivel-2 td:first-child { padding-left: 65px; color: #6a7c8d; font-size: 13px; }
        .nivel-3 td:first-child { padding-left: 85px; color: #7f8c8d; font-size: 12px; }
        .nivel-3 td:first-child .item-description { font-style: italic; }
        .nivel--1 { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; font-weight: 700; border-top: 3px solid #1e3c72; }
        .valor-positivo { color: #27ae60; font-weight: 600; }
        .valor-negativo { color: #e74c3c; font-weight: 600; }
        .variacao-header { text-align: center; }
        .variacao-subheader { display: flex; width: 100%; border-top: 1px solid rgba(255, 255, 255, 0.2); margin-top: 5px; padding-top: 5px; }
        .variacao-subheader span { flex: 1; text-align: center; font-size: 11px; }
        .variacao-cells { display: flex; gap: 15px; justify-content: flex-end; align-items: center; }
        .btn-lancamentos {
            background-color: #e8ecf0; color: #5a6c7d; border: 1px solid #cbd5e0;
            padding: 2px 8px; font-size: 11px; border-radius: 5px; cursor: pointer;
            margin-left: 15px; white-space: nowrap;
        }
        .btn-lancamentos:hover { background-color: #cbd5e0; }
        .btn { padding: 12px 24px; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; display: flex; align-items: center; gap: 8px; text-decoration: none; }
        .btn-voltar { background: #34495e; color: white; }
        .btn-print { background: #2a5298; color: white; }
        .btn-excel { background: #27ae60; color: white; }
        .toggle-btn { cursor: pointer; font-family: monospace; font-size: 16px; font-weight: bold; margin-right: 10px; color: #2a5298; width: 20px; text-align: center; user-select: none; flex-shrink: 0; }

        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: white; padding: 25px; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: auto; max-width: 90%; max-height: 90vh;
            display: flex; flex-direction: column;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            border-bottom: 1px solid #e5e5e5;
            padding-bottom: 15px; margin-bottom: 15px;
        }
        .modal-header h3 { color: #1e3c72; font-size: 18px; line-height: 1.4; }
        .modal-close-btn { font-size: 28px; font-weight: bold; color: #888; cursor: pointer; line-height: 1; padding-left: 20px; }
        .modal-close-btn:hover { color: #000; }
        .modal-body { overflow-y: auto; }

        .lancamentos-table {
            width: auto; min-width: 640px;
            border-collapse: collapse; font-size: 12px;
            table-layout: fixed; white-space: nowrap;
        }
        .lancamentos-table th, .lancamentos-table td {
            padding: 8px; border: 1px solid #ddd;
            text-align: left; font-family: monospace;
        }
        .lancamentos-table th {
            background-color: #2a5298; color: white;
            font-weight: bold; position: sticky; top: 0;
        }
        .lancamentos-table col.col-conta { width: 110px; }
        .lancamentos-table col.col-ug { width: 90px; }
        .lancamentos-table col.col-doc { width: 130px; }
        .lancamentos-table col.col-evento { width: 80px; }
        .lancamentos-table col.col-dc { width: 50px; }
        .lancamentos-table col.col-valor { width: 140px; }
        .lancamentos-table td:nth-child(5) { text-align: center; }
        .lancamentos-table td:last-child, .lancamentos-table tfoot td { text-align: right; font-weight: bold; }

        .chart-container { background: white; padding: 30px 20px; margin-top: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .chart-controls { margin-bottom: 25px; text-align: center; }
        .chart-btn { padding: 10px 20px; border: 1px solid #2a5298; background-color: #fff; color: #2a5298; cursor: pointer; border-radius: 5px; font-size: 14px; margin: 0 5px; }
        .chart-btn.active { background-color: #2a5298; color: #fff; }
        .chart-wrapper { max-width: 1200px; height: 450px; margin: 0 auto; text-align: center; }

        .resumo-container {
            background: #e9eef5;
            padding: 25px 30px;
            margin-top: 25px;
            border-radius: 10px;
            border: 1px solid #d1d9e6;
        }
        .resumo-container h2 {
            text-align: center; color: #1e3c72;
            margin-bottom: 25px; font-weight: 600;
        }
        .resumo-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }
        .resumo-card {
            background-color: #f8fafc;
            border-left: 4px solid #2a5298;
            padding: 18px; border-radius: 5px;
            flex-grow: 1;
            flex-basis: 220px;
            max-width: 280px;
        }
        .resumo-label {
            display: block; font-size: 13px;
            color: #5a6c7d; margin-bottom: 8px;
        }
        .resumo-valor {
            display: block;
            font-size: 22px;
            font-weight: 600; color: #1e3c72;
            white-space: nowrap;
        }
        .resumo-valor.positivo { color: #27ae60; }
        .resumo-valor.negativo { color: #e74c3c; }
        .resumo-subtext {
            font-size: 12px; color: #7f8c8d;
            margin-top: 4px; white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis;
        }

        /* Estilos do Comparativo Mensal */
        .comparativo-mensal-container {
            background: #f8f9fa;
            padding: 30px;
            margin-top: 25px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .comparativo-mensal-container h2 {
            text-align: center;
            color: #1e3c72;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .comparativo-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 40px;
        }

        .comparativo-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            min-width: 180px;
            max-width: 220px;
            flex: 1 1 auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .comparativo-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .comparativo-card .card-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px 15px;
            text-align: center;
        }

        .mes-label {
            font-weight: 600;
            font-size: 14px;
            white-space: pre-line;
            display: block;
        }

        .comparativo-card .card-body {
            padding: 15px;
        }

        .ano-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .ano-label {
            font-weight: 600;
            color: #5a6c7d;
            font-size: 13px;
        }

        .valor {
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
        }

        .variacao-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #f0f0f0;
        }

        .variacao-label {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 12px;
        }

        .variacao-valor {
            font-weight: 700;
            font-size: 14px;
        }

        .variacao-valor.positiva {
            color: #27ae60;
        }

        .variacao-valor.negativa {
            color: #e74c3c;
        }

        .comparativo-grafico-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            height: 400px;
        }

        .empty-state { text-align: center; padding: 80px 20px; color: #7f8c8d; }

        /* Responsividade */
        @media (max-width: 768px) {
            .comparativo-cards {
                gap: 10px;
            }
            
            .comparativo-card {
                min-width: 150px;
                max-width: 180px;
            }
            
            .mes-label {
                font-size: 12px;
            }
            
            .ano-label, .valor {
                font-size: 12px;
            }
        }

        @media print {
            .comparativo-mensal-container {
                page-break-inside: avoid;
            }
            
            .comparativo-grafico-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Balanço Orçamentário da Receita</h1>
            <p>Demonstrativo consolidado comparativo entre a previsão e a realização das receitas</p>
        </div>

        <div class="top-actions">
             <a href="{{ url_for('relatorios.index') }}" class="btn btn-voltar">🏠 Voltar ao Início</a>
            <button class="btn btn-print" onclick="window.print()">📄 Imprimir Relatório</button>
            <a href="{{ url_for('relatorios.balanco_orcamentario_receita', formato='excel', coug=coug_selecionada, filtro=filtro_ativo or '') }}" class="btn btn-excel">📊 Exportar para Excel</a>
        </div>

        <div class="filter-actions">
            <a href="{{ url_for('relatorios.balanco_orcamentario_receita', coug=coug_selecionada) }}" class="btn-filter {% if not filtro_ativo %}active{% endif %}">🧾 Todas as Receitas</a>
            <a href="{{ url_for('relatorios.balanco_orcamentario_receita', coug=coug_selecionada, filtro='tributarias') }}" class="btn-filter {% if filtro_ativo == 'tributarias' %}active{% endif %}">Receitas Tributárias</a>
            <a href="{{ url_for('relatorios.balanco_orcamentario_receita', coug=coug_selecionada, filtro='contribuicoes') }}" class="btn-filter {% if filtro_ativo == 'contribuicoes' %}active{% endif %}">Contribuições</a>
            <a href="{{ url_for('relatorios.balanco_orcamentario_receita', coug=coug_selecionada, filtro='patrimonial') }}" class="btn-filter {% if filtro_ativo == 'patrimonial' %}active{% endif %}">Receita Patrimonial</a>
            <a href="{{ url_for('relatorios.balanco_orcamentario_receita', coug=coug_selecionada, filtro='agropecuaria') }}" class="btn-filter {% if filtro_ativo == 'agropecuaria' %}active{% endif %}">Receita Agropecuária</a>
            <a href="{{ url_for('relatorios.balanco_orcamentario_receita', coug=coug_selecionada, filtro='industrial') }}" class="btn-filter {% if filtro_ativo == 'industrial' %}active{% endif %}">Receita Industrial</a>
            <a href="{{ url_for('relatorios.balanco_orcamentario_receita', coug=coug_selecionada, filtro='servicos') }}" class="btn-filter {% if filtro_ativo == 'servicos' %}active{% endif %}">Receita de Serviços</a>
            <a href="{{ url_for('relatorios.balanco_orcamentario_receita', coug=coug_selecionada, filtro='transf_correntes') }}" class="btn-filter {% if filtro_ativo == 'transf_correntes' %}active{% endif %}">Transf. Correntes</a>
            <a href="{{ url_for('relatorios.balanco_orcamentario_receita', coug=coug_selecionada, filtro='outras_correntes') }}" class="btn-filter {% if filtro_ativo == 'outras_correntes' %}active{% endif %}">Outras Receitas Correntes</a>
            <a href="{{ url_for('relatorios.balanco_orcamentario_receita', coug=coug_selecionada, filtro='op_credito') }}" class="btn-filter {% if filtro_ativo == 'op_credito' %}active{% endif %}">Operações de Crédito</a>
            <a href="{{ url_for('relatorios.balanco_orcamentario_receita', coug=coug_selecionada, filtro='alienacao_bens') }}" class="btn-filter {% if filtro_ativo == 'alienacao_bens' %}active{% endif %}">Alienação de Bens</a>
            <a href="{{ url_for('relatorios.balanco_orcamentario_receita', coug=coug_selecionada, filtro='amortizacao') }}" class="btn-filter {% if filtro_ativo == 'amortizacao' %}active{% endif %}">Amortização de Empréstimos</a>
            <a href="{{ url_for('relatorios.balanco_orcamentario_receita', coug=coug_selecionada, filtro='transf_capital') }}" class="btn-filter {% if filtro_ativo == 'transf_capital' %}active{% endif %}">Transf. de Capital</a>
        </div>

        <div class="periodo-info">
            <div>
                <span><strong>Período de Referência:</strong> {{ periodo.periodo_completo }}</span>
                <span class="separator">|</span>
                <span><strong>Data de Geração:</strong> {{ data_geracao }}</span>
            </div>
            <div class="info-consolidado">
                <select id="seletor-coug" class="select-coug" onchange="mudarCOUG(this.value)">
                    <option value="">📊 DADOS CONSOLIDADOS</option>
                    {% for coug in cougs %}
                    <option value="{{ coug.codigo }}" {% if coug_selecionada == coug.codigo %}selected{% endif %}>🏛️ {{ coug.descricao_completa }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="table-container">
            {% if dados and dados|length > 1 %}
            <table>
                <thead>
                    <tr>
                        <th>RECEITAS</th>
                        <th>PREVISÃO INICIAL<br>{{ periodo.ano }}</th>
                        <th>PREVISÃO ATUALIZADA<br>{{ periodo.ano }}</th>
                        <th>RECEITA REALIZADA<br>{{ "%02d"|format(periodo.mes) }}/{{ periodo.ano }}</th>
                        <th>RECEITA REALIZADA<br>{{ "%02d"|format(periodo.mes) }}/{{ periodo.ano - 1 }}</th>
                        <th>
                            <div class="variacao-header">
                                <span>VARIAÇÃO {{ periodo.ano }} X {{ periodo.ano - 1 }}</span>
                                <div class="variacao-subheader"><span>VALOR ABSOLUTO</span><span>%</span></div>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in dados %}
                    <tr class="{{ item.classes }}" data-level="{{ item.nivel }}">
                        <td>
                            {% if item.classes and item.classes.find('parent-row') != -1 %}
                            <span class="toggle-btn" data-state="collapsed">[+]</span>
                            {% endif %}
                            <span class="item-description">{{ item.descricao }}</span>
                            {% if item.nivel == 3 and item.tem_lancamentos and coug_selecionada %}
                                <button class="btn-lancamentos"
                                    onclick="abrirModalLancamentos(this)"
                                    data-params='{{ item.params_lancamentos|tojson|safe }}'>
                                    Lançamentos
                                </button>
                            {% endif %}
                        </td>
                        <td>{{ item.previsao_inicial|formatar_moeda }}</td>
                        <td>{{ item.previsao_atualizada|formatar_moeda }}</td>
                        <td>{{ item.receita_atual|formatar_moeda }}</td>
                        <td>{{ item.receita_anterior|formatar_moeda }}</td>
                        <td>
                            <div class="variacao-cells">
                                <span class="variacao-valor {% if item.variacao_absoluta >= 0 %}valor-positivo{% else %}valor-negativo{% endif %}">{{ item.variacao_absoluta|formatar_moeda }}</span>
                                <span class="variacao-percentual {% if item.variacao_percentual >= 0 %}valor-positivo{% else %}valor-negativo{% endif %}">{{ item.variacao_percentual|formatar_percentual }}</span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state"><h3>Nenhum dado encontrado</h3><p>Verifique os filtros ou a disponibilidade de dados para o período.</p></div>
            {% endif %}
        </div>

        {% if chart_data_categorias or chart_data_origens %}
        <div class="chart-container">
            <div class="chart-controls">
                <button id="btn-cat" class="chart-btn active" onclick="updateChart('categorias')">Gráfico por Categorias</button>
                <button id="btn-ori" class="chart-btn" onclick="updateChart('origens')">Gráfico por Origens</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="receitaPieChart"></canvas>
            </div>
        </div>
        {% endif %}

        {% if resumo_executivo %}
        <div class="resumo-container">
            <h2>📊 Resumo Executivo</h2>
            {% if coug_selecionada and nome_coug %}
            <p style="text-align: center; color: #5a6c7d; font-size: 16px; margin-top: -10px; margin-bottom: 20px;">{{ nome_coug }}</p>
            {% endif %}
            <div class="resumo-grid">
                <div class="resumo-card">
                    <span class="resumo-label">Receita Total {{ periodo.ano }}</span>
                    <span class="resumo-valor">{{ resumo_executivo.total_geral.receita_2025 | formatar_moeda }}</span>
                </div>
                <div class="resumo-card">
                    <span class="resumo-label">Receita Total {{ periodo.ano - 1 }}</span>
                    <span class="resumo-valor">{{ resumo_executivo.total_geral.receita_2024 | formatar_moeda }}</span>
                </div>
                <div class="resumo-card">
                    <span class="resumo-label">Variação Total ({{ periodo.ano }} x {{ periodo.ano - 1 }})</span>
                    <span class="resumo-valor {{ 'positivo' if resumo_executivo.total_geral.variacao_pct >= 0 else 'negativo' }}">
                        {{ resumo_executivo.total_geral.variacao_pct | formatar_percentual }}
                    </span>
                    <div class="resumo-subtext">{{ resumo_executivo.total_geral.variacao_abs | formatar_moeda }}</div>
                </div>
                {% if resumo_executivo.categoria_principal %}
                <div class="resumo-card">
                    <span class="resumo-label">Principal Categoria de Receita</span>
                    <span class="resumo-valor">{{ resumo_executivo.categoria_principal.valor | formatar_moeda }}</span>
                    <div class="resumo-subtext">{{ resumo_executivo.categoria_principal.descricao }}</div>
                </div>
                {% endif %}
                {% if resumo_executivo.maior_crescimento %}
                <div class="resumo-card">
                    <span class="resumo-label">Maior Crescimento em Valor</span>
                    <span class="resumo-valor positivo">+ {{ resumo_executivo.maior_crescimento.valor | formatar_moeda }}</span>
                    <div class="resumo-subtext">{{ resumo_executivo.maior_crescimento.descricao }}</div>
                </div>
                {% endif %}
                {% if resumo_executivo.maior_queda %}
                <div class="resumo-card">
                    <span class="resumo-label">Maior Queda em Valor</span>
                    <span class="resumo-valor negativo">{{ resumo_executivo.maior_queda.valor | formatar_moeda }}</span>
                    <div class="resumo-subtext">{{ resumo_executivo.maior_queda.descricao }}</div>
                </div>
                {% endif %}
                <div class="resumo-card">
                    <span class="resumo-label">Total de Detalhamentos</span>
                    <span class="resumo-valor">{{ resumo_executivo.contagem_detalhamentos }}</span>
                    <div class="resumo-subtext">Alíneas com Movimento</div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if comparativo_mensal and comparativo_mensal.dados_html.tem_dados %}
        <div class="comparativo-mensal-container">
            <h2>📈 {{ titulo_comparativo }}</h2>
            {% if coug_selecionada and nome_coug %}
            <p style="text-align: center; color: #5a6c7d; font-size: 16px; margin-top: -10px; margin-bottom: 20px;">{{ nome_coug }}</p>
            {% endif %}
            
            <!-- Cards do Comparativo -->
            <div class="comparativo-cards">
                {% for mes in comparativo_mensal.dados_html.meses %}
                <div class="comparativo-card">
                    <div class="card-header">
                        <span class="mes-label">📊 {{ mes.label_ate }}</span>
                    </div>
                    <div class="card-body">
                        <div class="ano-row">
                            <span class="ano-label">{{ mes.ano_anterior }}:</span>
                            <span class="valor">{{ mes.receita_anterior_formatada }}</span>
                        </div>
                        <div class="ano-row">
                            <span class="ano-label">{{ mes.ano_atual }}:</span>
                            <span class="valor">{{ mes.receita_atual_formatada }}</span>
                        </div>
                        <div class="variacao-row">
                            <span class="variacao-label">Variação:</span>
                            <span class="variacao-valor {{ mes.variacao_classe }}">
                                {{ mes.variacao_formatada|safe }}
                            </span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Gráfico de Evolução -->
            <div class="comparativo-grafico-container">
                <canvas id="comparativoMensalChart"></canvas>
            </div>
        </div>
        {% endif %}
    </div>

    <div id="lancamentos-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div id="modal-title"></div>
                <span class="modal-close-btn" onclick="fecharModalLancamentos()">&times;</span>
            </div>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function mudarCOUG(coug) {
            const url = new URL(window.location);
            if (coug) { url.searchParams.set('coug', coug); }
            else { url.searchParams.delete('coug'); }
            window.location.href = url.toString();
        }

        const modal = document.getElementById('lancamentos-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');

        function fecharModalLancamentos() {
            modal.style.display = 'none';
            modalBody.innerHTML = '';
        }

        async function abrirModalLancamentos(button) {
            const parentRow = button.closest('tr');
            const itemDescription = parentRow.querySelector('.item-description').textContent;
            const valorRealizado2025 = parentRow.cells[3].textContent.trim();

            const cougSelect = document.getElementById('seletor-coug');
            const cougValue = cougSelect.value;
            let cougHeaderHtml = '';
            if (cougValue) {
                const cougText = cougSelect.options[cougSelect.selectedIndex].text.replace('🏛️', '').trim();
                cougHeaderHtml = `<h3 style="color: #555; font-size: 16px; margin-bottom: 10px;">Unidade Gestora: ${cougText}</h3>`;
            }

            modalTitle.innerHTML = `
                ${cougHeaderHtml}
                <h3>Lançamentos para: ${itemDescription}</h3>
                <div style="margin-top: 5px; font-size: 14px;">Valor Apurado no Relatório: <strong>${valorRealizado2025}</strong></div>
            `;
            modalBody.innerHTML = '<p>Buscando lançamentos...</p>';
            modal.style.display = 'flex';

            const params = JSON.parse(button.dataset.params);
            const url = new URL(`${window.location.origin}/relatorios/balanco-orcamentario-receita/lancamentos`);
            url.searchParams.set('ano', {{ periodo.ano }});
            url.searchParams.set('mes', {{ periodo.mes }});
            if (cougValue) url.searchParams.set('coug', cougValue);
            for (const key in params) {
                url.searchParams.set(key, params[key]);
            }

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (!response.ok || data.erro) throw new Error(data.erro || 'Erro ao buscar dados.');

                if (data.length === 0) {
                    modalBody.innerHTML = '<p>Nenhum lançamento encontrado para este item com os filtros aplicados.</p>';
                } else {
                    let tableHtml = `
                        <table class="lancamentos-table">
                            <colgroup>
                                <col class="col-conta"><col class="col-ug"><col class="col-doc"><col class="col-evento"><col class="col-dc"><col class="col-valor">
                            </colgroup>
                            <thead><tr><th>Conta Contábil</th><th>UG Emitente</th><th>Documento</th><th>Evento</th><th>D/C</th><th>Valor</th></tr></thead>
                            <tbody>`;

                    let total = 0;
                    data.forEach(l => {
                        const dc = l.INDEBITOCREDITO;
                        const valor = l.VALANCAMENTO;

                        if (dc === 'C') { total += valor; }
                        else if (dc === 'D') { total -= valor; }

                        tableHtml += `
                            <tr>
                                <td>${l.COCONTACONTABIL || ''}</td>
                                <td>${l.COUG || ''}</td>
                                <td>${l.NUDOCUMENTO || ''}</td>
                                <td>${l.COEVENTO || ''}</td>
                                <td>${l.INDEBITOCREDITO || ''}</td>
                                <td>${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(l.VALANCAMENTO)}</td>
                            </tr>`;
                    });

                    tableHtml += `
                        </tbody><tfoot><tr>
                        <td colspan="5">Total Líquido dos Lançamentos:</td>
                        <td>${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(total)}</td>
                        </tr></tfoot></table>`;
                    modalBody.innerHTML = tableHtml;
                }
            } catch (error) {
                console.error('Erro ao buscar lançamentos:', error);
                modalBody.innerHTML = `<p style="color: red;">Não foi possível carregar os lançamentos. ${error.message}</p>`;
            }
        }

        window.onclick = function(event) { if (event.target == modal) fecharModalLancamentos(); }
        window.onkeydown = function(event) { if (event.key === "Escape") fecharModalLancamentos(); }

        // Dados do gráfico do comparativo mensal
        {% if comparativo_mensal and comparativo_mensal.dados_grafico %}
        window.comparativoMensalData = {{ comparativo_mensal.dados_grafico|tojson|safe }};
        {% endif %}

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const parentRow = this.closest('tr');
                    const parentLevel = parseInt(parentRow.dataset.level, 10);
                    let nextRow = parentRow.nextElementSibling;
                    const isCollapsed = this.dataset.state === 'collapsed';
                    this.dataset.state = isCollapsed ? 'expanded' : 'collapsed';
                    this.textContent = isCollapsed ? '[-]' : '[+]';
                    while (nextRow && parseInt(nextRow.dataset.level, 10) > parentLevel) {
                        if (parseInt(nextRow.dataset.level, 10) === parentLevel + 1) {
                             nextRow.style.display = isCollapsed ? 'table-row' : 'none';
                        }
                        if (!isCollapsed) {
                            nextRow.style.display = 'none';
                            const childBtn = nextRow.querySelector('.toggle-btn');
                            if (childBtn) {
                                childBtn.dataset.state = 'collapsed';
                                childBtn.textContent = '[+]';
                            }
                        }
                        nextRow = nextRow.nextElementSibling;
                    }
                });
            });

            const chartCanvas = document.getElementById('receitaPieChart');
            if (chartCanvas) {
                const chartData = {
                    categorias: {{ chart_data_categorias|tojson|safe }},
                    origens: {{ chart_data_origens|tojson|safe }}
                };
                let myPieChart = null;
                window.updateChart = function(viewType) {
                    const btnCat = document.getElementById('btn-cat');
                    const btnOri = document.getElementById('btn-ori');
                    if (!btnCat || !btnOri) return;
                    const currentData = chartData[viewType];
                    const chartTitle = viewType === 'categorias' ? 'Distribuição da Receita por Categorias' : 'Distribuição da Receita por Origens';
                    const cougInfo = {% if coug_selecionada and nome_coug %}`{{ nome_coug }}`{% else %}null{% endif %};
                    const titleArray = cougInfo ? [chartTitle, cougInfo] : [chartTitle];
                    btnCat.classList.toggle('active', viewType === 'categorias');
                    btnOri.classList.toggle('active', viewType === 'origens');
                    const ctx = chartCanvas.getContext('2d');
                    if (myPieChart) { myPieChart.destroy(); }
                    if (!currentData || currentData.length === 0) { return; }
                    const labels = currentData.map(item => item.label);
                    const data = currentData.map(item => item.value);
                    const backgroundColors = ['#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b'];
                    const pieColors = data.map((_, i) => backgroundColors[i % backgroundColors.length]);
                    myPieChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{ label: 'Receita Realizada', data: data, backgroundColor: pieColors, hoverOffset: 4 }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    align: 'center',
                                    labels: {
                                        padding: 15,
                                        boxWidth: 15,
                                        font: { size: 13 },
                                        generateLabels: function(chart) {
                                            const data = chart.data;
                                            if (data.labels.length && data.datasets.length) {
                                                return data.labels.map((label, i) => {
                                                    const value = data.datasets[0].data[i];
                                                    const formattedValue = new Intl.NumberFormat('pt-BR', {
                                                        style: 'decimal',
                                                        minimumFractionDigits: 2,
                                                        maximumFractionDigits: 2
                                                    }).format(value);

                                                    return {
                                                        text: `${label}                     R$ ${formattedValue}`,
                                                        fillStyle: data.datasets[0].backgroundColor[i],
                                                        strokeStyle: data.datasets[0].backgroundColor[i],
                                                        lineWidth: 0,
                                                        index: i
                                                    };
                                                });
                                            }
                                            return [];
                                        }
                                    }
                                },
                                title: { display: true, text: titleArray, font: { size: 18, weight: 'bold' }, padding: { top: 0, bottom: 20 } },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const value = context.parsed;
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                            const formattedValue = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                                            return `${context.label}: ${formattedValue} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                updateChart('categorias');
            }

            // Gráfico do Comparativo Mensal
            const comparativoCanvas = document.getElementById('comparativoMensalChart');
            if (comparativoCanvas && window.comparativoMensalData) {
                const ctx = comparativoCanvas.getContext('2d');
                
                const comparativoChart = new Chart(ctx, {
                    type: 'line',
                    data: window.comparativoMensalData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Evolução Acumulada da Receita',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            legend: {
                                position: 'top',
                                labels: {
                                    padding: 20,
                                    font: {
                                        size: 14
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        const formattedValue = new Intl.NumberFormat('pt-BR', {
                                            style: 'currency',
                                            currency: 'BRL'
                                        }).format(value);
                                        return context.dataset.label + ': ' + formattedValue;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return new Intl.NumberFormat('pt-BR', {
                                            style: 'currency',
                                            currency: 'BRL',
                                            notation: 'compact',
                                            maximumFractionDigits: 1
                                        }).format(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>